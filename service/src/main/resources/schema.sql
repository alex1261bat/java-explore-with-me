DROP TABLE IF EXISTS users, categories, events, requests, compilations, event_compilations, comments CASCADE ;

CREATE TABLE IF NOT EXISTS users (
    USER_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMAIL CHARACTER VARYING NOT NULL,
    NAME CHARACTER VARYING NOT NULL,
    COMMENTS_IS_BLOCKED BOOLEAN DEFAULT FALSE,
    CONSTRAINT uq_email UNIQUE (EMAIL)
    );

CREATE TABLE IF NOT EXISTS categories (
    CATEGORY_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME CHARACTER VARYING NOT NULL,
    CONSTRAINT uq_category_name UNIQUE (NAME)
    );

CREATE TABLE IF NOT EXISTS events (
    EVENT_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ANNOTATION CHARACTER VARYING NOT NULL,
    CATEGORY_ID BIGINT REFERENCES categories (CATEGORY_ID) ON DELETE RESTRICT,
    DESCRIPTION CHARACTER VARYING NOT NULL,
    EVENT_DATE TIMESTAMP WITHOUT TIME ZONE NOT NULL,
    LAT REAL NOT NULL,
    LON REAL NOT NULL,
    PAID BOOLEAN DEFAULT FALSE,
    PARTICIPANT_LIMIT BIGINT DEFAULT 0,
    REQUEST_MODERATION BOOLEAN DEFAULT TRUE,
    TITLE CHARACTER VARYING NOT NULL,
    CREATED_ON TIMESTAMP WITHOUT TIME ZONE NOT NULL,
    INITIATOR BIGINT REFERENCES users (USER_ID) ON DELETE RESTRICT,
    PUBLISHED_ON TIMESTAMP WITHOUT TIME ZONE,
    STATE CHARACTER VARYING
    );

CREATE TABLE IF NOT EXISTS requests (
    REQUEST_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CREATED TIMESTAMP WITHOUT TIME ZONE NOT NULL,
    EVENT_ID BIGINT REFERENCES events (EVENT_ID) ON DELETE RESTRICT,
    REQUESTER_ID BIGINT REFERENCES users (USER_ID) ON DELETE RESTRICT,
    STATUS CHARACTER VARYING,
    CONSTRAINT uq_request UNIQUE (EVENT_ID, REQUESTER_ID)
    );

CREATE TABLE IF NOT EXISTS compilations (
    COMPILATION_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PINNED BOOLEAN DEFAULT FALSE,
    TITLE CHARACTER VARYING NOT NULL
    );

CREATE TABLE IF NOT EXISTS event_compilations (
    COMPILATION_ID BIGINT REFERENCES compilations(COMPILATION_ID) ON DELETE RESTRICT,
    EVENT_ID BIGINT REFERENCES events(EVENT_ID) ON DELETE RESTRICT,
    PRIMARY KEY (COMPILATION_ID, EVENT_ID)
    );

CREATE TABLE IF NOT EXISTS comments (
    COMMENT_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TEXT CHARACTER VARYING(5000) NOT NULL,
    STATE CHARACTER VARYING DEFAULT 'NOT_EDITED',
    CREATED TIMESTAMP WITHOUT TIME ZONE NOT NULL,
    EDITED TIMESTAMP WITHOUT TIME ZONE,
    AUTHOR_ID BIGINT REFERENCES users(USER_ID) ON DELETE RESTRICT,
    EVENT_ID BIGINT REFERENCES events(EVENT_ID) ON DELETE RESTRICT
    );
